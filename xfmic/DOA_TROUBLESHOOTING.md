# RK3328 声源定位问题诊断报告

## 问题总结

**现象**: 使用Python程序无法接收到设备的唤醒事件（声源定位信息），但11月23日使用`screen`命令可以成功获取。

**设备**: RK3328降噪板 + 环形六麦阵列
**串口**: `/dev/tty.usbserial-2130` 或 `/dev/tty.usbserial-2140`
**波特率**: 115200

## 根本原因分析

### 观察到的行为

1. **screen 命令 (11月23日成功)**:
   - 只监听串口，不发送任何数据
   - 说"小飞小飞"后能收到JSON格式的DOA信息
   - 包含 `angle`、`beam`、`score` 等字段

2. **Python程序 (12月2日失败)**:
   - 程序发送握手确认 (0x03消息)
   - 设备只返回握手消息 (0x01) 和未知消息 (0xFF)
   - 从不发送设备消息 (0x02) - 这是包含DOA信息的消息类型

### 关键发现

**发送数据会干扰设备的正常工作！**

当我们的程序响应设备的握手消息时，设备似乎进入了某种"命令模式"，停止主动发送唤醒事件。这可能是：
- 固件的特殊行为
- 协议版本不匹配
- 设备需要特定的初始化序列

## 解决方案

### 方案1: passive_listen_only.py (推荐)

**特点**: 完全模拟screen命令，带协议解析和唤醒检测

```bash
python3 passive_listen_only.py
```

**实现原理**:
```python
# 只打开串口读取，绝不调用 ser.write()
ser = serial.Serial(port=port, baudrate=115200, timeout=1)
ser.reset_input_buffer()  # 清空输入缓冲

while True:
    if ser.in_waiting > 0:
        data = ser.read(ser.in_waiting)
        # 只解析和显示，不发送任何响应
        parse_and_display(data)
```

**预期输出**:
```
[12:36:45] 接收 89 字节:
  HEX: A5 01 02 4D 00 03 00 7B 22 74 79 70 65 22 ...

  📦 消息 #5:
     类型: 设备消息
     消息ID: 3
     数据长度: 77 字节
     JSON 数据:
     {
           "type": "wakeup",
           "content": {
                 "angle": 45,
                 "score": 0.92,
                 "beam": 1,
                 "keyword": "小飞小飞"
           }
     }

     🎉 唤醒事件 #1!
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     🎯 声源角度: 45°
     📊 置信得分: 0.92
     📡 波束编号: 1
     🎤 唤醒词: 小飞小飞
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 方案2: ultra_simple_listen.py (最简单)

**特点**: 极简实现，直接显示HEX和文本

```bash
python3 ultra_simple_listen.py
```

### 方案3: screen 命令 (你11月23日的方法)

```bash
screen /dev/tty.usbserial-2130 115200
```

退出: `Ctrl+A` → `K` → `Y`

### 方案4: 一键测试脚本

```bash
./test_solution.sh
```

## 设备消息类型说明

根据抓取的数据，设备发送以下消息：

| 类型 | 十六进制 | 说明 | 频率 |
|------|---------|------|------|
| 握手 | 0x01 | 设备启动时发送 | 启动时，约每秒1次 |
| 设备消息 | 0x02 | **包含唤醒事件和DOA信息** | 检测到唤醒词时 |
| 确认 | 0x03 | 对主控命令的确认 | 响应我们的命令时 |
| 主控命令 | 0x04 | 我们发给设备的命令 | 我们发送时 |
| 未知 | 0xFF | 含4字节数据 `A5 00 00 00` | 周期性，用途未知 |

**关键**: 只有 **0x02 类型的设备消息** 才包含DOA信息！

## 测试步骤

1. **连接确认**:
   ```bash
   ls /dev/tty.usbserial*
   # 应该看到 /dev/tty.usbserial-2130 或类似设备
   ```

2. **运行监听程序**:
   ```bash
   python3 passive_listen_only.py
   ```

3. **等待设备初始化** (约5-10秒):
   - 会看到一些握手消息 (0x01)
   - 可能看到一些 0xFF 消息
   - 这是正常的

4. **语音唤醒测试**:
   - 对着麦克风清晰地说: **"小飞小飞"** 或 **"小微小微"**
   - 距离麦克风约 20-50cm
   - 语速正常，发音清晰

5. **预期结果**:
   - 应该立即看到 `🎉 唤醒事件!` 的输出
   - 包含声源角度、波束编号、置信得分

## 波束方向对照表

RK3328 环形六麦阵列的6个波束对应方向：

```
         Beam 0 (0°)
            ↑
            |
Beam 5 ↖    |    ↗ Beam 1
  (300°)    |    (60°)
            |
            |
Beam 4 ←----O----→ Beam 2
  (240°)         (120°)
            |
            ↓
         Beam 3 (180°)
```

## 如果仍然无法获取DOA信息

### 诊断清单

- [ ] 串口设备存在且可访问
- [ ] RK3328降噪板已上电 (DC 12V)
- [ ] 6个麦克风均已通过排线连接
- [ ] 使用纯监听模式（不发送任何数据）
- [ ] 唤醒词发音清晰
- [ ] 环境相对安静

### 进一步排查

1. **验证设备是否正常工作**:
   ```bash
   # 使用最简单的监听器查看原始数据
   python3 ultra_simple_listen.py
   ```
   说唤醒词后，应该能看到包含 `"type":"wakeup"` 的HEX数据

2. **检查是否是唤醒词问题**:
   - 默认唤醒词应该是 "小微小微"
   - 如果文档中默认是 "小飞小飞"，可能需要查看设备配置

3. **使用screen命令再次验证** (你11月23日成功的方法):
   ```bash
   screen /dev/tty.usbserial-2130 115200
   ```

4. **联系厂商**:
   - 如果以上都不工作，可能需要厂商提供最新固件或协议文档
   - 询问是否需要通过官方Windows工具进行初始配置

## 技术细节

### 消息格式

```
字节   | 0  | 1      | 2       | 3-4    | 5-6    | 7...      | 最后
-------|----| -------|---------|--------|--------|-----------|------
内容   | A5 | UserID | MsgType | Length | MsgID  | Data      | Checksum
说明   | 同步| 用户ID | 消息类型| 长度   | 消息ID | JSON数据   | 校验码
```

### 校验码计算

```python
checksum = (~sum(data[0:7+msg_len]) + 1) & 0xFF
```

### 唤醒事件JSON格式

```json
{
  "type": "wakeup",
  "content": {
    "angle": 45,      // 声源角度 0-359°
    "score": 0.92,    // 置信得分 0.0-1.0
    "beam": 1,        // 波束编号 0-5
    "keyword": "小飞小飞"  // 识别到的唤醒词
  }
}
```

## 创建时间

2024-12-02

## 作者

Claude Code & 用户协作调试
